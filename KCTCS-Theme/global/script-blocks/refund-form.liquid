document.addEventListener('DOMContentLoaded', function() {
    // Find the refund amount input
    const refundInput = document.querySelector('input[name="answers[a0xbc000001IvYjAAK][answer]"]');
    const form = document.querySelector('form[action*="form_submission"]');
    
    if (!refundInput) return;
    
    // Add wrapper and help text
    const wrapper = document.createElement('div');
    wrapper.className = 'refund-amount-wrapper';
    refundInput.parentNode.insertBefore(wrapper, refundInput);
    wrapper.appendChild(refundInput);
    
    // Add error message element
    const errorSpan = document.createElement('span');
    errorSpan.className = 'refund-amount-error';
    errorSpan.id = 'refund-amount-error';
    wrapper.appendChild(errorSpan);
    
    // Add help text
    const helpSpan = document.createElement('span');
    helpSpan.className = 'refund-help-text';
    helpSpan.textContent = 'Enter amount:';
    wrapper.appendChild(helpSpan);
    
    // Validation function
    function validateRefundAmount(value) {
        // Convert to string and remove any non-numeric characters except decimal
        const cleanValue = value.toString().replace(/[^0-9.]/g, '');
        
        // Check if empty
        if (!cleanValue || cleanValue === '') {
            return { valid: false, message: 'Refund amount is required' };
        }
        
        // Check if it's a valid number
        const number = parseFloat(cleanValue);
        if (isNaN(number)) {
            return { valid: false, message: 'Please enter a valid number' };
        }
        
        // Check if positive
        if (number <= 0) {
            return { valid: false, message: 'Refund amount must be greater than $0.00' };
        }
        
        // Check decimal places
        const decimalParts = cleanValue.split('.');
        if (decimalParts.length > 2) {
            return { valid: false, message: 'Invalid number format' };
        }
        
        if (decimalParts[1] && decimalParts[1].length > 2) {
            return { valid: false, message: 'Maximum 2 decimal places allowed' };
        }
        
        // Check total digits (9 digits including decimals)
        const totalDigits = cleanValue.replace('.', '').length;
        if (totalDigits > 9) {
            return { valid: false, message: 'Maximum 9 digits allowed (including decimal places)' };
        }
        
        // Alternative validation: 7 digits before decimal, 2 after (up to 9,999,999.99)
        const wholePart = Math.floor(number);
        if (wholePart.toString().length > 7) {
            return { valid: false, message: 'Amount too large (maximum $9,999,999.99)' };
        }
        
        return { valid: true, message: '' };
    }
    
    // Format number to 2 decimal places
    function formatCurrency(value) {
        const number = parseFloat(value);
        if (isNaN(number)) return '';
        return number.toFixed(2);
    }
    
    // Show/hide error message
    function showError(message) {
        errorSpan.textContent = message;
        errorSpan.classList.add('show');
        refundInput.classList.add('refund-amount-invalid');
        refundInput.classList.remove('refund-amount-valid');
    }
    
    function hideError() {
        errorSpan.textContent = '';
        errorSpan.classList.remove('show');
        refundInput.classList.remove('refund-amount-invalid');
        refundInput.classList.add('refund-amount-valid');
    }
    
    function clearValidation() {
        errorSpan.textContent = '';
        errorSpan.classList.remove('show');
        refundInput.classList.remove('refund-amount-invalid');
        refundInput.classList.remove('refund-amount-valid');
    }
    
    // Input validation on keypress (prevent invalid characters)
    refundInput.addEventListener('keypress', function(e) {
        const char = String.fromCharCode(e.which);
        const currentValue = this.value;
        
        // Allow: backspace, delete, tab, escape, enter
        if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
            // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
            (e.keyCode === 65 && e.ctrlKey === true) ||
            (e.keyCode === 67 && e.ctrlKey === true) ||
            (e.keyCode === 86 && e.ctrlKey === true) ||
            (e.keyCode === 88 && e.ctrlKey === true)) {
            return;
        }
        
        // Allow only digits and decimal point
        if (!/[0-9.]/.test(char)) {
            e.preventDefault();
            return;
        }
        
        // Allow only one decimal point
        if (char === '.' && currentValue.indexOf('.') !== -1) {
            e.preventDefault();
            return;
        }
        
        // Prevent more than 2 decimal places
        const decimalIndex = currentValue.indexOf('.');
        if (decimalIndex !== -1 && currentValue.substring(decimalIndex + 1).length >= 2 && 
            this.selectionStart > decimalIndex) {
            e.preventDefault();
            return;
        }
        
        // Check total digits limit
        const futureValue = currentValue + char;
        const totalDigits = futureValue.replace('.', '').length;
        if (totalDigits > 9) {
            e.preventDefault();
            return;
        }
    });
    
    // Validation on input (real-time)
    refundInput.addEventListener('input', function(e) {
        const validation = validateRefundAmount(this.value);
        
        if (this.value === '') {
            clearValidation();
        } else if (!validation.valid) {
            showError(validation.message);
        } else {
            hideError();
        }
    });
    
    // Validation on blur (format the number)
    refundInput.addEventListener('blur', function(e) {
        if (this.value && !isNaN(parseFloat(this.value))) {
            this.value = formatCurrency(this.value);
        }
        
        const validation = validateRefundAmount(this.value);
        if (!validation.valid && this.value !== '') {
            showError(validation.message);
        }
    });
    
    // Form submission validation
    if (form) {
        form.addEventListener('submit', function(e) {
            const validation = validateRefundAmount(refundInput.value);
            
            if (!validation.valid) {
                e.preventDefault();
                showError(validation.message);
                
                // Scroll to the error
                refundInput.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                // Focus the input
                refundInput.focus();
                
                return false;
            }
        });
    }
    
    // Initialize validation if there's already a value
    if (refundInput.value) {
        const validation = validateRefundAmount(refundInput.value);
        if (!validation.valid) {
            showError(validation.message);
        } else {
            hideError();
        }
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const orderSelect = document.querySelector('select[name="answers[a0xbc000001IvTtAAK][answer]"]');
    
    if (!orderSelect) return;
    
    // JavaScript removal (more reliable than CSS)
    const canceledOptions = orderSelect.querySelectorAll('option[value="canceled"]');
    canceledOptions.forEach(option => option.remove());
    
    // Add visual styling
    orderSelect.classList.add('filtered-order-select');
    
    // Add indicator
    const indicator = document.createElement('div');
    indicator.className = 'filter-indicator';
    indicator.textContent = ``;
    orderSelect.parentNode.appendChild(indicator);
    
});

/*
KCTCS Refund Request â€” Force dropdown to submit order reference
Ensures Salesforce receives the actual order reference number
instead of the order status after StoreConnect renders the form.
*/
document.addEventListener('DOMContentLoaded', function () {
  const selector = 'select[name="answers[a0xbc000001IvTtAAK][answer]"]';
  setTimeout(function () {
    const select = document.querySelector(selector);
    if (!select) return;
    Array.from(select.options).forEach(function (opt) {
      const txt = (opt.text || opt.textContent || '').trim();
      if (txt && (txt.startsWith('BG') || txt.startsWith('SC'))) opt.value = txt;
    });
  }, 1000);
});